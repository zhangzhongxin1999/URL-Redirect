<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Universal Content Proxy with User-defined Mapping</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
    }
    .container {
      background: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c6bed;
      text-align: center;
    }
    .usage {
      background: #f0f8ff;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    }
    .example {
      font-family: monospace;
      background: #f4f4f4;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      margin: 5px 0;
      word-break: break-all;
    }
    .instructions {
      margin: 20px 0;
    }
    ol {
      padding-left: 20px;
    }
    li {
      margin: 10px 0;
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 10px;
      border-radius: 5px;
      margin: 15px 0;
    }
    .feature-box {
      background: #e8f4fd;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }
    .service-section {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    .url-generator {
      background: #f0f8f0;
      border: 1px solid #c8e6c8;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"], input[type="url"], textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    textarea {
      height: 120px;
      font-family: monospace;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #45a049;
    }
    .result {
      margin-top: 15px;
      padding: 10px;
      background-color: #e8f4fd;
      border-radius: 4px;
      display: none;
    }
    .result.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîÑ Universal Content Proxy</h1>
    <div class="warning">
      <strong>üîí Security Notice:</strong> For enhanced security, consider restricting access to this service. 
      Visit <a href="/admin/access-control">admin panel</a> to set up authentication (requires credentials).
    </div>
    
    <div class="service-section">
      <h2>1. üìÑ Unified URL Mapping System</h2>
      <p>Create custom mappings for any URL using your own user ID and custom paths</p>
      
      <div class="form-group">
        <label for="targetUrl">Target URL to map:</label>
        <input type="url" id="targetUrl" placeholder="e.g., https://example.com/data.json or https://gist.githubusercontent.com/user/gist-id/raw/file.js">
      </div>
      
      <div class="form-group">
        <label for="userId">Your User ID:</label>
        <input type="text" id="userId" placeholder="e.g., myuser123">
      </div>
      
      <div class="form-group">
        <label for="customPath">Custom Path:</label>
        <input type="text" id="customPath" placeholder="e.g., my-api-endpoint or my-gist-file">
      </div>
      
      <div class="form-group">
        <label for="siteUrl">Your Site URL:</label>
        <input type="url" id="siteUrl" value="https://your-site.pages.dev" placeholder="e.g., https://your-site.pages.dev">
      </div>
      
      <button onclick="createUserMapping()">Create Custom Mapping</button>
      
      <div id="mappingResult" class="result">
        <p><strong>Your Custom Mapping:</strong></p>
        <p><a id="mappingUrl" href="#" target="_blank"></a></p>
        <p>Mapping Key: <span id="mappingKeyDisplay"></span></p>
      </div>
    </div>
    
    <div class="persistent-text-generator">
      <h2>2. ‚úçÔ∏è Text Content Mapping</h2>
      <p>Store text content and access it via your custom mapping</p>
      
      <div class="form-group">
        <label for="persistentContent">Content:</label>
        <textarea id="persistentContent" placeholder="Âú®Ê≠§ËæìÂÖ•ÊÇ®ÁöÑÊñáÊú¨ÂÜÖÂÆπ..."></textarea>
      </div>
      
      <div class="form-group">
        <label for="persistentFilename">File Name (with extension):</label>
        <input type="text" id="persistentFilename" value="config.txt" placeholder="‰æãÂ¶ÇÔºöconfig.json, script.js">
      </div>
      
      <div class="form-group">
        <label for="textUserId">Your User ID:</label>
        <input type="text" id="textUserId" placeholder="e.g., myuser123">
      </div>
      
      <div class="form-group">
        <label for="textCustomPath">Custom Path:</label>
        <input type="text" id="textCustomPath" placeholder="e.g., my-config or my-script">
      </div>
      
      <div class="form-group">
        <label for="persistentTextSiteUrl">Your Site URL:</label>
        <input type="url" id="persistentTextSiteUrl" value="https://your-site.pages.dev" placeholder="‰æãÂ¶ÇÔºöhttps://your-site.pages.dev">
      </div>
      
      <button onclick="createPersistentText()">Create Text Mapping</button>
      
      <div id="persistentTextResult" class="result">
        <p><strong>Text Mapping URL:</strong></p>
        <p><a id="persistentTextUrl" href="#" target="_blank"></a></p>
        <p>Mapping Key: <span id="persistentTextKeyDisplay"></span></p>
      </div>
    </div>
    
    <div class="qrcode-generator">
      <h2>3. üì± QR Code Generator</h2>
      <p>Generate QR codes for any URL for mobile scanning:</p>
      
      <div class="form-group">
        <label for="qrcodeUrl">URL:</label>
        <input type="url" id="qrcodeUrl" placeholder="Enter URL to generate QR code for">
      </div>
      
      <button onclick="generateQRCode()">Generate QR Code</button>
      
      <div id="qrcodeResult" class="result">
        <p><strong>QR Code:</strong></p>
        <div id="qrcodeContainer" style="display:flex; justify-content:center; margin:10px 0;"></div>
      </div>
    </div>
    
    <div class="instructions">
      <h2>How to Use</h2>
      <ol>
        <li>Create a custom mapping by providing a target URL, your user ID, and a custom path</li>
        <li>Access your mapped content using the format: <code>https://your-site.pages.dev/m/{userId}/{customPath}</code></li>
        <li>Use the QR code generator to create scannable codes for your URLs</li>
        <li>All mappings are stored persistently using Cloudflare KV</li>
      </ol>
    </div>
    
    <div class="warning">
      <strong>Note:</strong> This proxy is intended to help access legitimate content. Please respect terms of service and applicable laws in your jurisdiction.
    </div>
    
    <div class="features">
      <h2>Features</h2>
      <ul>
        <li>Unified URL mapping system with user-defined paths</li>
        <li>Persistent storage using Cloudflare KV</li>
        <li>Custom user IDs and paths for organized access</li>
        <li>Text content storage and retrieval</li>
        <li>QR code generation for easy mobile access</li>
        <li>Maintains original content type headers</li>
        <li>Supports all file types (JavaScript, CSS, JSON, text, etc.)</li>
        <li>Automatic download with specified filename</li>
      </ul>
    </div>
  </div>
  
  <script>
    async function createUserMapping() {
      const targetUrl = document.getElementById('targetUrl').value;
      const userId = document.getElementById('userId').value;
      const customPath = document.getElementById('customPath').value;
      const siteUrl = document.getElementById('siteUrl').value;
      
      if (!targetUrl) {
        alert('Please enter the target URL to map');
        return;
      }
      
      if (!userId) {
        alert('Please enter your user ID');
        return;
      }
      
      if (!customPath) {
        alert('Please enter a custom path');
        return;
      }
      
      if (!siteUrl) {
        alert('Please enter your site URL');
        return;
      }
      
      try {
        // Use the API endpoint to create a persistent mapping
        const formData = new FormData();
        formData.append('originalUrl', targetUrl);
        formData.append('userId', userId);
        formData.append('customPath', customPath);
        formData.append('baseUrl', siteUrl);
        
        const response = await fetch('/api/create-user-mapping', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Update the result section
          document.getElementById('mappingUrl').href = data.mappedUrl;
          document.getElementById('mappingUrl').textContent = data.mappedUrl;
          document.getElementById('mappingKeyDisplay').textContent = data.mappingKey;
          
          document.getElementById('mappingResult').classList.add('show');
          
          // Add QR code button
          setTimeout(() => {
            addQRCodeToElement('mappingUrl');
          }, 100);
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Error creating user mapping: ' + error.message);
      }
    }
    
    async function createPersistentText() {
      const content = document.getElementById('persistentContent').value;
      const filename = document.getElementById('persistentFilename').value;
      const userId = document.getElementById('textUserId').value;
      const customPath = document.getElementById('textCustomPath').value;
      const siteUrl = document.getElementById('persistentTextSiteUrl').value;
      
      if (!content) {
        alert('Please enter the content');
        return;
      }
      
      if (!filename) {
        alert('Please enter a filename');
        return;
      }
      
      if (!userId) {
        alert('Please enter your user ID');
        return;
      }
      
      if (!customPath) {
        alert('Please enter a custom path');
        return;
      }
      
      if (!siteUrl) {
        alert('Please enter your site URL');
        return;
      }
      
      try {
        // Use the API endpoint to create persistent text content
        const formData = new FormData();
        formData.append('content', content);
        formData.append('filename', filename);
        formData.append('userId', userId);
        formData.append('customPath', customPath);
        formData.append('baseUrl', siteUrl);
        
        const response = await fetch('/api/create-persistent-text', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Update the result section
          document.getElementById('persistentTextUrl').href = data.persistentUrl;
          document.getElementById('persistentTextUrl').textContent = data.persistentUrl;
          document.getElementById('persistentTextKeyDisplay').textContent = data.mappingKey;
          
          document.getElementById('persistentTextResult').classList.add('show');
          
          // Add QR code button
          setTimeout(() => {
            addQRCodeToElement('persistentTextUrl');
          }, 100);
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Error creating persistent text: ' + error.message);
      }
    }
    
    async function generateQRCode() {
      const url = document.getElementById('qrcodeUrl').value;
      
      if (!url) {
        alert('Please enter a URL');
        return;
      }
      
      try {
        // Validate URL
        new URL(url);
        
        // Generate QR code using the API
        const qrCodeUrl = `/qrcode/generate?url=${encodeURIComponent(url)}`;
        
        // Create an image element for the QR code
        const img = document.createElement('img');
        img.src = qrCodeUrl;
        img.alt = 'QR Code';
        img.style.maxWidth = '300px';
        img.style.height = 'auto';
        img.onerror = function() {
          alert('Error generating QR code');
        };
        
        // Clear previous QR code and add the new one
        const container = document.getElementById('qrcodeContainer');
        container.innerHTML = '';
        container.appendChild(img);
        
        // Show the result div
        document.getElementById('qrcodeResult').classList.add('show');
      } catch (error) {
        alert('Invalid URL: ' + error.message);
      }
    }
    
    // Add QR code functionality to existing URL generators
    function addQRCodeToElement(elementId) {
      const element = document.getElementById(elementId);
      if (element && element.href) {
        // Create a button to generate QR code for this specific URL
        const qrButton = document.createElement('button');
        qrButton.textContent = 'QR';
        qrButton.onclick = function() {
          const qrCodeUrl = `/qrcode/generate?url=${encodeURIComponent(element.href)}`;
          window.open(qrCodeUrl, '_blank', 'width=350,height=400');
        };
        qrButton.style.marginLeft = '10px';
        qrButton.style.verticalAlign = 'middle';
        element.parentNode.appendChild(qrButton);
      }
    }
  </script>
</body>
</html>