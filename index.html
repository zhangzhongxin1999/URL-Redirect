<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Universal Content Proxy with User-defined Mapping</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
    }
    .container {
      background: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c6bed;
      text-align: center;
    }
    .usage {
      background: #f0f8ff;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    }
    .example {
      font-family: monospace;
      background: #f4f4f4;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      margin: 5px 0;
      word-break: break-all;
    }
    .instructions {
      margin: 20px 0;
    }
    ol {
      padding-left: 20px;
    }
    li {
      margin: 10px 0;
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 10px;
      border-radius: 5px;
      margin: 15px 0;
    }
    .feature-box {
      background: #e8f4fd;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }
    .service-section {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    .url-generator {
      background: #f0f8f0;
      border: 1px solid #c8e6c8;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"], input[type="url"], input[type="email"], input[type="password"], textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    textarea {
      height: 120px;
      font-family: monospace;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #45a049;
    }
    .auth-button {
      background-color: #2196F3;
    }
    .auth-button:hover {
      background-color: #0b7dda;
    }
    .logout-button {
      background-color: #f44336;
    }
    .logout-button:hover {
      background-color: #da190b;
    }
    .result {
      margin-top: 15px;
      padding: 10px;
      background-color: #e8f4fd;
      border-radius: 4px;
      display: none;
    }
    .result.show {
      display: block;
    }
    .mapping-item {
      border: 1px solid #ddd;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    .delete-btn {
      background-color: #f44336;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      float: right;
    }
    .delete-btn:hover {
      background-color: #da190b;
    }
    .auth-status {
      margin: 10px 0;
      padding: 10px;
      background-color: #e8f5e8;
      border-radius: 4px;
      display: none;
    }
    .auth-status.authenticated {
      background-color: #e8f5e8;
      border: 1px solid #4CAF50;
    }
    .auth-status.unauthenticated {
      background-color: #ffeaea;
      border: 1px solid #f44336;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîÑ Universal Content Proxy</h1>
    <div class="warning">
      <strong>üîí Security Notice:</strong> For enhanced security, consider restricting access to this service. 
      Visit <a href="/admin/access-control">admin panel</a> to set up authentication (requires credentials).
    </div>
    
    <div class="auth-section">
      <h2>üîê Account</h2>
      <p>Register or login to manage your mappings</p>
      
      <div id="authStatus" class="auth-status">
        <span id="authStatusText"></span>
        <button class="logout-button" onclick="logout()" style="float: right; display: none;" id="logoutBtn">Logout</button>
      </div>
      
      <!-- Registration Form -->
      <div class="form-group">
        <label for="registerUserId">Desired User ID:</label>
        <input type="text" id="registerUserId" placeholder="e.g., myuser123">
      </div>
      
      <div class="form-group">
        <label for="registerEmail">Email (optional):</label>
        <input type="email" id="registerEmail" placeholder="e.g., user@example.com">
      </div>
      
      <div class="form-group">
        <label for="registerPassword">Password:</label>
        <input type="password" id="registerPassword" placeholder="Enter password">
      </div>
      
      <button class="auth-button" onclick="registerUser()">Register</button>
      
      <!-- Login Form -->
      <div class="form-group" style="margin-top: 20px;">
        <label for="loginUserId">User ID:</label>
        <input type="text" id="loginUserId" placeholder="e.g., myuser123">
      </div>
      
      <div class="form-group">
        <label for="loginPassword">Password:</label>
        <input type="password" id="loginPassword" placeholder="Enter password">
      </div>
      
      <button class="auth-button" onclick="loginUser()">Login</button>
    </div>
    
    <div class="user-management">
      <h2>üë§ User Management</h2>
      <p>View and manage your mappings</p>
      
      <div class="form-group">
        <label for="manageUserId">Your User ID:</label>
        <input type="text" id="manageUserId" placeholder="e.g., myuser123" disabled>
      </div>
      
      <button onclick="viewUserMappings()" disabled>View My Mappings</button>
      
      <div id="userMappingsResult" class="result">
        <p><strong>Your Mappings:</strong></p>
        <div id="mappingsList"></div>
      </div>
    </div>
    
    <div class="service-section">
      <h2>1. üìÑ Unified URL Mapping System</h2>
      <p>Create custom mappings for any URL using your own user ID and custom paths</p>
      
      <div class="form-group">
        <label for="targetUrl">Target URL to map:</label>
        <input type="url" id="targetUrl" placeholder="e.g., https://example.com/data.json or https://gist.githubusercontent.com/user/gist-id/raw/file.js" disabled>
      </div>
      
      <div class="form-group">
        <label for="userId">Your User ID:</label>
        <input type="text" id="userId" placeholder="e.g., myuser123" disabled>
      </div>
      
      <div class="form-group">
        <label for="customPath">Custom Path:</label>
        <input type="text" id="customPath" placeholder="e.g., my-api-endpoint or my-gist-file" disabled>
      </div>
      
      <button onclick="createUserMapping()" disabled>Create Custom Mapping</button>
      
      <div id="mappingResult" class="result">
        <p><strong>Your Custom Mapping:</strong></p>
        <p><a id="mappingUrl" href="#" target="_blank"></a></p>
        <p>Mapping Key: <span id="mappingKeyDisplay"></span></p>
      </div>
    </div>
    
    <div class="persistent-text-generator">
      <h2>2. ‚úçÔ∏è Text Content Mapping</h2>
      <p>Store text content and access it via your custom mapping</p>
      
      <div class="form-group">
        <label for="persistentContent">Content:</label>
        <textarea id="persistentContent" placeholder="Âú®Ê≠§ËæìÂÖ•ÊÇ®ÁöÑÊñáÊú¨ÂÜÖÂÆπ..." disabled></textarea>
      </div>
      
      <div class="form-group">
        <label for="persistentFilename">File Name (with extension):</label>
        <input type="text" id="persistentFilename" value="config.txt" placeholder="‰æãÂ¶ÇÔºöconfig.json, script.js" disabled>
      </div>
      
      <div class="form-group">
        <label for="textUserId">Your User ID:</label>
        <input type="text" id="textUserId" placeholder="e.g., myuser123" disabled>
      </div>
      
      <div class="form-group">
        <label for="textCustomPath">Custom Path:</label>
        <input type="text" id="textCustomPath" placeholder="e.g., my-config or my-script" disabled>
      </div>
      
      <button onclick="createPersistentText()" disabled>Create Text Mapping</button>
      
      <div id="persistentTextResult" class="result">
        <p><strong>Text Mapping URL:</strong></p>
        <p><a id="persistentTextUrl" href="#" target="_blank"></a></p>
        <p>Mapping Key: <span id="persistentTextKeyDisplay"></span></p>
      </div>
    </div>
    
    <div class="qrcode-generator">
      <h2>3. üì± QR Code Generator</h2>
      <p>Generate QR codes for any URL for mobile scanning:</p>
      
      <div class="form-group">
        <label for="qrcodeUrl">URL:</label>
        <input type="url" id="qrcodeUrl" placeholder="Enter URL to generate QR code for" disabled>
      </div>
      
      <button onclick="generateQRCode()" disabled>Generate QR Code</button>
      
      <div id="qrcodeResult" class="result">
        <p><strong>QR Code:</strong></p>
        <div id="qrcodeContainer" style="display:flex; justify-content:center; margin:10px 0;"></div>
      </div>
    </div>
    
    <div class="instructions">
      <h2>How to Use</h2>
      <ol>
        <li>Register an account or login to get started</li>
        <li>Create a custom mapping by providing a target URL, your user ID, and a custom path</li>
        <li>Access your mapped content using the format: <code>https://your-site.pages.dev/m/{userId}/{customPath}</code></li>
        <li>Use the user management section to view and manage your existing mappings</li>
        <li>Use the QR code generator to create scannable codes for your URLs</li>
        <li>All mappings are stored persistently using Cloudflare KV</li>
      </ol>
    </div>
    
    <div class="warning">
      <strong>Note:</strong> This proxy is intended to help access legitimate content. Please respect terms of service and applicable laws in your jurisdiction.
    </div>
    
    <div class="features">
      <h2>Features</h2>
      <ul>
        <li>User registration and authentication</li>
        <li>Unified URL mapping system with user-defined paths</li>
        <li>Persistent storage using Cloudflare KV</li>
        <li>Custom user IDs and paths for organized access</li>
        <li>User management to view and delete mappings</li>
        <li>Text content storage and retrieval</li>
        <li>QR code generation for easy mobile access</li>
        <li>Maintains original content type headers</li>
        <li>Supports all file types (JavaScript, CSS, JSON, text, etc.)</li>
        <li>Automatic download with specified filename</li>
      </ul>
    </div>
  </div>
  
  <script>
    // Authentication state
    let currentUser = null;
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Check if user is logged in from localStorage
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        updateAuthStatus(true);
      }
    });
    
    function updateAuthStatus(isAuthenticated) {
      const authStatusDiv = document.getElementById('authStatus');
      const authStatusText = document.getElementById('authStatusText');
      const logoutBtn = document.getElementById('logoutBtn');
      
      if (isAuthenticated && currentUser) {
        authStatusDiv.className = 'auth-status authenticated';
        authStatusText.textContent = `Logged in as: ${currentUser.userId}`;
        logoutBtn.style.display = 'block';
        
        // Enable forms that require authentication
        document.getElementById('manageUserId').value = currentUser.userId;
        document.getElementById('manageUserId').disabled = false;
        document.getElementById('userId').value = currentUser.userId;
        document.getElementById('userId').disabled = false;
        document.getElementById('textUserId').value = currentUser.userId;
        document.getElementById('textUserId').disabled = false;
        
        // Enable buttons
        document.querySelectorAll('button:not(.auth-button):not(#logoutBtn)').forEach(btn => {
          btn.disabled = false;
        });
      } else {
        authStatusDiv.className = 'auth-status unauthenticated';
        authStatusText.textContent = 'Not logged in. Please register or login to continue.';
        logoutBtn.style.display = 'none';
        
        // Disable forms that require authentication
        document.getElementById('manageUserId').value = '';
        document.getElementById('manageUserId').disabled = true;
        document.getElementById('userId').value = '';
        document.getElementById('userId').disabled = true;
        document.getElementById('textUserId').value = '';
        document.getElementById('textUserId').disabled = true;
        
        // Disable buttons
        document.querySelectorAll('button:not(.auth-button):not(#logoutBtn)').forEach(btn => {
          btn.disabled = true;
        });
      }
      
      authStatusDiv.style.display = 'block';
    }
    
    async function registerUser() {
      const userId = document.getElementById('registerUserId').value;
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      
      if (!userId || !password) {
        alert('User ID and password are required');
        return;
      }
      
      try {
        const formData = new FormData();
        formData.append('userId', userId);
        if (email) formData.append('email', email);
        formData.append('password', password);
        
        const response = await fetch('/auth/register', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert('Registration successful! You can now login.');
          document.getElementById('registerUserId').value = '';
          document.getElementById('registerEmail').value = '';
          document.getElementById('registerPassword').value = '';
        } else {
          alert('Registration failed: ' + data.error);
        }
      } catch (error) {
        alert('Error registering user: ' + error.message);
      }
    }
    
    async function loginUser() {
      const userId = document.getElementById('loginUserId').value;
      const password = document.getElementById('loginPassword').value;
      
      if (!userId || !password) {
        alert('User ID and password are required');
        return;
      }
      
      try {
        const formData = new FormData();
        formData.append('userId', userId);
        formData.append('password', password);
        
        const response = await fetch('/auth/login', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Store user info in localStorage
          currentUser = { userId: userId };
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          
          updateAuthStatus(true);
          alert('Login successful!');
          document.getElementById('loginUserId').value = '';
          document.getElementById('loginPassword').value = '';
        } else {
          alert('Login failed: ' + data.error);
        }
      } catch (error) {
        alert('Error logging in user: ' + error.message);
      }
    }
    
    function logout() {
      currentUser = null;
      localStorage.removeItem('currentUser');
      updateAuthStatus(false);
      alert('Logged out successfully!');
    }
    
    async function createUserMapping() {
      if (!currentUser) {
        alert('Please login first');
        return;
      }
      
      const targetUrl = document.getElementById('targetUrl').value;
      const userId = document.getElementById('userId').value;
      const customPath = document.getElementById('customPath').value;
      
      if (!targetUrl) {
        alert('Please enter the target URL to map');
        return;
      }
      
      if (!userId) {
        alert('Please enter your user ID');
        return;
      }
      
      if (!customPath) {
        alert('Please enter a custom path');
        return;
      }
      
      try {
        // Use the API endpoint to create a persistent mapping
        const formData = new FormData();
        formData.append('originalUrl', targetUrl);
        formData.append('userId', userId);
        formData.append('customPath', customPath);
        
        const response = await fetch('/api/create-user-mapping', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Update the result section
          document.getElementById('mappingUrl').href = data.mappedUrl;
          document.getElementById('mappingUrl').textContent = data.mappedUrl;
          document.getElementById('mappingKeyDisplay').textContent = data.mappingKey;
          
          document.getElementById('mappingResult').classList.add('show');
          
          // Add QR code button
          setTimeout(() => {
            addQRCodeToElement('mappingUrl');
          }, 100);
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Error creating user mapping: ' + error.message);
      }
    }
    
    async function createPersistentText() {
      if (!currentUser) {
        alert('Please login first');
        return;
      }
      
      const content = document.getElementById('persistentContent').value;
      const filename = document.getElementById('persistentFilename').value;
      const userId = document.getElementById('textUserId').value;
      const customPath = document.getElementById('textCustomPath').value;
      
      if (!content) {
        alert('Please enter the content');
        return;
      }
      
      if (!filename) {
        alert('Please enter a filename');
        return;
      }
      
      if (!userId) {
        alert('Please enter your user ID');
        return;
      }
      
      if (!customPath) {
        alert('Please enter a custom path');
        return;
      }
      
      try {
        // Use the API endpoint to create persistent text content
        const formData = new FormData();
        formData.append('content', content);
        formData.append('filename', filename);
        formData.append('userId', userId);
        formData.append('customPath', customPath);
        
        const response = await fetch('/api/create-persistent-text', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Update the result section
          document.getElementById('persistentTextUrl').href = data.persistentUrl;
          document.getElementById('persistentTextUrl').textContent = data.persistentUrl;
          document.getElementById('persistentTextKeyDisplay').textContent = data.mappingKey;
          
          document.getElementById('persistentTextResult').classList.add('show');
          
          // Add QR code button
          setTimeout(() => {
            addQRCodeToElement('persistentTextUrl');
          }, 100);
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Error creating persistent text: ' + error.message);
      }
    }
    
    async function generateQRCode() {
      if (!currentUser) {
        alert('Please login first');
        return;
      }
      
      const url = document.getElementById('qrcodeUrl').value;
      
      if (!url) {
        alert('Please enter a URL');
        return;
      }
      
      try {
        // Validate URL
        new URL(url);
        
        // Generate QR code using the API
        const qrCodeUrl = `/qrcode/generate?url=${encodeURIComponent(url)}`;
        
        // Create an image element for the QR code
        const img = document.createElement('img');
        img.src = qrCodeUrl;
        img.alt = 'QR Code';
        img.style.maxWidth = '300px';
        img.style.height = 'auto';
        img.onerror = function() {
          alert('Error generating QR code');
        };
        
        // Clear previous QR code and add the new one
        const container = document.getElementById('qrcodeContainer');
        container.innerHTML = '';
        container.appendChild(img);
        
        // Show the result div
        document.getElementById('qrcodeResult').classList.add('show');
      } catch (error) {
        alert('Invalid URL: ' + error.message);
      }
    }
    
    async function viewUserMappings() {
      if (!currentUser) {
        alert('Please login first');
        return;
      }
      
      const userId = document.getElementById('manageUserId').value;
      
      if (!userId) {
        alert('Please enter your user ID');
        return;
      }
      
      try {
        const response = await fetch(`/api/user/${encodeURIComponent(userId)}/mappings`);
        const data = await response.json();
        
        if (data.success) {
          const mappingsListDiv = document.getElementById('mappingsList');
          mappingsListDiv.innerHTML = '';
          
          if (data.mappings.length === 0) {
            mappingsListDiv.innerHTML = '<p>No mappings found for this user.</p>';
          } else {
            data.mappings.forEach(mapping => {
              const mappingItem = document.createElement('div');
              mappingItem.className = 'mapping-item';
              
              let contentPreview = '';
              if (mapping.type === 'url_mapping') {
                contentPreview = `<strong>Type:</strong> URL Mapping<br>
                                  <strong>Original URL:</strong> ${mapping.originalUrl}<br>`;
              } else if (mapping.type === 'text_content') {
                contentPreview = `<strong>Type:</strong> Text Content<br>
                                  <strong>Filename:</strong> ${mapping.filename}<br>
                                  <strong>Content Preview:</strong> ${mapping.contentPreview}<br>`;
              }
              
              mappingItem.innerHTML = `
                <div>
                  <strong>Custom Path:</strong> ${mapping.customPath}<br>
                  ${contentPreview}
                  <strong>Created:</strong> ${new Date(mapping.createdAt).toLocaleString()}<br>
                  <strong>Full Path:</strong> /m/${userId}/${mapping.customPath}<br>
                  <a href="/m/${userId}/${mapping.customPath}" target="_blank">Open</a>
                  <button class="delete-btn" onclick="deleteMapping('${userId}', '${mapping.customPath}')">Delete</button>
                </div>
              `;
              
              mappingsListDiv.appendChild(mappingItem);
            });
          }
          
          document.getElementById('userMappingsResult').classList.add('show');
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Error fetching user mappings: ' + error.message);
      }
    }
    
    async function deleteMapping(userId, customPath) {
      if (!currentUser) {
        alert('Please login first');
        return;
      }
      
      if (!confirm(`Are you sure you want to delete the mapping "${customPath}" for user "${userId}"?`)) {
        return;
      }
      
      try {
        const response = await fetch(`/api/user/${encodeURIComponent(userId)}/mappings/${encodeURIComponent(customPath)}/delete`, {
          method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert('Mapping deleted successfully!');
          // Refresh the mappings list
          viewUserMappings();
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Error deleting mapping: ' + error.message);
      }
    }
    
    // Add QR code functionality to existing URL generators
    function addQRCodeToElement(elementId) {
      const element = document.getElementById(elementId);
      if (element && element.href) {
        // Create a button to generate QR code for this specific URL
        const qrButton = document.createElement('button');
        qrButton.textContent = 'QR';
        qrButton.onclick = function() {
          const qrCodeUrl = `/qrcode/generate?url=${encodeURIComponent(element.href)}`;
          window.open(qrCodeUrl, '_blank', 'width=350,height=400');
        };
        qrButton.style.marginLeft = '10px';
        qrButton.style.verticalAlign = 'middle';
        element.parentNode.appendChild(qrButton);
      }
    }
  </script>
</body>
</html>